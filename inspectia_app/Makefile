# =============================================================================
# MAKEFILE INSPECTIA - DOCKERISATION COMPLÃˆTE
# =============================================================================

.PHONY: help build start stop restart logs status clean clean-all deploy rollback

# Variables
COMPOSE_FILE = docker-compose.yml
PROJECT_NAME = inspectia

# Couleurs
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
RED = \033[0;31m
NC = \033[0m # No Color

# Aide
help:
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘                          ğŸš€ INSPECTIA DOCKER COMPLET                        â•‘$(NC)"
	@echo "$(BLUE)â•‘                    SystÃ¨me ML-RL avec 21 tables PostgreSQL                 â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)Commandes disponibles:$(NC)"
	@echo ""
	@echo "  $(YELLOW)build$(NC)        - Construire toutes les images Docker"
	@echo "  $(YELLOW)start$(NC)        - DÃ©marrer tous les services"
	@echo "  $(YELLOW)start-monitoring$(NC) - DÃ©marrer avec monitoring (Prometheus/Grafana)"
	@echo "  $(YELLOW)stop$(NC)         - ArrÃªter tous les services"
	@echo "  $(YELLOW)restart$(NC)      - RedÃ©marrer tous les services"
	@echo "  $(YELLOW)logs$(NC)         - Afficher les logs de tous les services"
	@echo "  $(YELLOW)logs-backend$(NC) - Afficher les logs du backend"
	@echo "  $(YELLOW)logs-frontend$(NC) - Afficher les logs du frontend"
	@echo "  $(YELLOW)status$(NC)       - Afficher le statut des services"
	@echo "  $(YELLOW)clean$(NC)        - Nettoyer les conteneurs arrÃªtÃ©s"
	@echo "  $(YELLOW)clean-all$(NC)    - Nettoyage complet (supprime tout)"
	@echo "  $(YELLOW)deploy$(NC)       - DÃ©ploiement complet en production"
	@echo "  $(YELLOW)rollback$(NC)     - Rollback vers la version prÃ©cÃ©dente"
	@echo "  $(YELLOW)backup$(NC)       - Sauvegarder les donnÃ©es"
	@echo "  $(YELLOW)restore$(NC)      - Restaurer les donnÃ©es"
	@echo "  $(YELLOW)health$(NC)       - VÃ©rifier la santÃ© des services"
	@echo "  $(YELLOW)test$(NC)         - ExÃ©cuter les tests"
	@echo ""
	@echo "$(GREEN)Services inclus:$(NC)"
	@echo "  â€¢ PostgreSQL (21 tables)"
	@echo "  â€¢ Backend FastAPI (98 endpoints)"
	@echo "  â€¢ Frontend Flutter (Web)"
	@echo "  â€¢ Streamlit Dashboard"
	@echo "  â€¢ MLflow (ML tracking)"
	@echo "  â€¢ Redis (Cache)"
	@echo "  â€¢ Nginx (Reverse Proxy)"
	@echo "  â€¢ Prometheus/Grafana (Monitoring)"
	@echo ""

# Construire les images
build:
	@echo "$(BLUE)ğŸ”¨ Construction des images Docker...$(NC)"
	docker-compose build --no-cache
	@echo "$(GREEN)âœ… Images construites avec succÃ¨s$(NC)"

# DÃ©marrer tous les services
start:
	@echo "$(BLUE)ğŸš€ DÃ©marrage de tous les services...$(NC)"
	./docker-start.sh start
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s$(NC)"

# DÃ©marrer avec monitoring
start-monitoring:
	@echo "$(BLUE)ğŸš€ DÃ©marrage avec monitoring...$(NC)"
	./docker-start.sh start --with-monitoring
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s avec monitoring$(NC)"

# ArrÃªter tous les services
stop:
	@echo "$(BLUE)ğŸ›‘ ArrÃªt de tous les services...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ… Services arrÃªtÃ©s$(NC)"

# RedÃ©marrer tous les services
restart:
	@echo "$(BLUE)ğŸ”„ RedÃ©marrage de tous les services...$(NC)"
	docker-compose restart
	@echo "$(GREEN)âœ… Services redÃ©marrÃ©s$(NC)"

# Afficher les logs
logs:
	@echo "$(BLUE)ğŸ“‹ Affichage des logs...$(NC)"
	docker-compose logs -f

# Logs du backend
logs-backend:
	@echo "$(BLUE)ğŸ“‹ Logs du backend...$(NC)"
	docker-compose logs -f backend

# Logs du frontend
logs-frontend:
	@echo "$(BLUE)ğŸ“‹ Logs du frontend...$(NC)"
	docker-compose logs -f frontend

# Statut des services
status:
	@echo "$(BLUE)ğŸ“Š Statut des services:$(NC)"
	docker-compose ps

# Nettoyer les conteneurs arrÃªtÃ©s
clean:
	@echo "$(BLUE)ğŸ§¹ Nettoyage des conteneurs arrÃªtÃ©s...$(NC)"
	docker-compose down --remove-orphans
	docker system prune -f
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

# Nettoyage complet
clean-all:
	@echo "$(BLUE)ğŸ§¹ Nettoyage complet...$(NC)"
	docker-compose down --rmi all --volumes --remove-orphans
	docker system prune -af
	@echo "$(GREEN)âœ… Nettoyage complet terminÃ©$(NC)"

# DÃ©ploiement complet
deploy:
	@echo "$(BLUE)ğŸš€ DÃ©ploiement complet...$(NC)"
	./scripts/deploy.sh deploy
	@echo "$(GREEN)âœ… DÃ©ploiement terminÃ©$(NC)"

# Rollback
rollback:
	@echo "$(BLUE)ğŸ”„ Rollback...$(NC)"
	./scripts/deploy.sh rollback
	@echo "$(GREEN)âœ… Rollback terminÃ©$(NC)"

# Sauvegarder les donnÃ©es
backup:
	@echo "$(BLUE)ğŸ’¾ Sauvegarde des donnÃ©es...$(NC)"
	./scripts/backup.sh
	@echo "$(GREEN)âœ… Sauvegarde terminÃ©e$(NC)"

# Restaurer les donnÃ©es
restore:
	@echo "$(BLUE)ğŸ“¥ Restauration des donnÃ©es...$(NC)"
	./scripts/restore.sh
	@echo "$(GREEN)âœ… Restauration terminÃ©e$(NC)"

# VÃ©rifier la santÃ© des services
health:
	@echo "$(BLUE)ğŸ” VÃ©rification de la santÃ© des services...$(NC)"
	@echo "Backend API:"
	@curl -f http://localhost:8000/health && echo " âœ…" || echo " âŒ"
	@echo "Frontend:"
	@curl -f http://localhost:3000 && echo " âœ…" || echo " âŒ"
	@echo "Streamlit:"
	@curl -f http://localhost:8501 && echo " âœ…" || echo " âŒ"
	@echo "MLflow:"
	@curl -f http://localhost:5000 && echo " âœ…" || echo " âŒ"
	@echo "PostgreSQL:"
	@docker-compose exec postgres pg_isready -U inspectia_user -d inspectia_db && echo " âœ…" || echo " âŒ"

# ExÃ©cuter les tests
test:
	@echo "$(BLUE)ğŸ§ª ExÃ©cution des tests...$(NC)"
	docker-compose exec backend python -m pytest tests/
	@echo "$(GREEN)âœ… Tests terminÃ©s$(NC)"

# Entrer dans un conteneur
shell-backend:
	@echo "$(BLUE)ğŸš Connexion au backend...$(NC)"
	docker-compose exec backend bash

shell-frontend:
	@echo "$(BLUE)ğŸš Connexion au frontend...$(NC)"
	docker-compose exec frontend sh

shell-db:
	@echo "$(BLUE)ğŸš Connexion Ã  la base de donnÃ©es...$(NC)"
	docker-compose exec postgres psql -U inspectia_user -d inspectia_db

# Afficher les informations des services
info:
	@echo "$(BLUE)ğŸŒ Services disponibles:$(NC)"
	@echo ""
	@echo "  ğŸ“± Frontend Flutter:     http://localhost:3000"
	@echo "  ğŸ”§ Backend API:          http://localhost:8000"
	@echo "  ğŸ“Š Streamlit Dashboard:  http://localhost:8501"
	@echo "  ğŸ¤– MLflow:              http://localhost:5000"
	@echo "  ğŸ—„ï¸  PostgreSQL:         localhost:5432"
	@echo "  ğŸ”´ Redis:               localhost:6379"
	@echo "  ğŸ“ˆ Prometheus:          http://localhost:9090"
	@echo "  ğŸ“Š Grafana:             http://localhost:3001"
	@echo ""

# Mise Ã  jour des services
update:
	@echo "$(BLUE)ğŸ”„ Mise Ã  jour des services...$(NC)"
	git pull
	docker-compose pull
	docker-compose up -d
	@echo "$(GREEN)âœ… Mise Ã  jour terminÃ©e$(NC)"

# Surveillance des ressources
monitor:
	@echo "$(BLUE)ğŸ“Š Surveillance des ressources...$(NC)"
	docker stats

# Par dÃ©faut, afficher l'aide
.DEFAULT_GOAL := help
